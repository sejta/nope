# nope — Routing Contract (v0.6)

Этот документ фиксирует **строгую спецификацию роутинга** в nope. Реализация должна соответствовать этому контракту.

---

## 1. Общие правила
1. Матчинг всегда по **HTTP‑методу + пути**.
2. Query‑string не участвует в матчинге.
3. Путь разбивается на сегменты по `/`.
4. Все маршруты регистрируются **до старта сервера**.
5. Роутер после старта — read‑only и thread‑safe.

---

## Policy (frozen since v0.6.0)

### Trailing slash
- `/a` и `/a/` — разные пути.
- Роутер **не** редиректит и не нормализует trailing slash.

Примеры:
- есть маршрут `/a` → запрос `/a/` = `404`
- есть маршрут `/a/` → запрос `/a` = `404`

### 404 vs 405 + Allow
- `405 Method Not Allowed` только если путь найден, но метод не поддерживается.
- `404 Not Found` если путь не найден.
- Заголовок `Allow` обязателен при `405`.
- `OPTIONS` не автогенерится.

Пример:
- есть `GET /healthz` → `POST /healthz` = `405` + `Allow: GET`

### Wildcard `*path`
- wildcard только в конце паттерна и не более одного на маршрут.
- `/assets` и `/assets/` матчятся в `/assets/*path` с `path == ""`.
- Значение `path` без ведущего `/`.
- Приоритеты: `static` > `param` > `wildcard`.
- Конфликтные wildcard‑паттерны при регистрации → `panic`.

Примеры:
- `/assets/logo.png` выигрывает у `/assets/*path`
- `/assets/:id` выигрывает у `/assets/*path`

### Encoding / URL.Path
- Роутер использует `r.URL.Path` как источник истины.
- Дополнительного декодирования сегментов не делает.

Пример:
- `/assets/a%20b/c` → `path` берётся как в `r.URL.Path`.

---

## 2. Поддерживаемые методы (v0.1)
- GET
- POST
- PUT
- PATCH
- DELETE

Другие методы → `405 Method Not Allowed`.

Роутер **не** автогенерит `OPTIONS` и не делает CORS‑magic.

---

## 3. Паттерны маршрутов

### 3.1 Static сегменты
```text
/posts
/users/list
```
Сегмент должен совпадать полностью.

---

### 3.2 Param сегменты
```text
/posts/:id
/users/:userId/orders/:orderId
```

**Правила:**
- `:param` совпадает с любым **непустым** сегментом
- имя параметра не содержит `/`
- значения параметров не декодируются автоматически

---

### 3.3 Wildcard сегменты (v0.3)
```text
/assets/*path
```

**Правила:**
- wildcard забирает остаток пути
- может быть пустым
- только **один** wildcard и только в конце паттерна
- wildcard матчится и для `/assets`, и для `/assets/` (значение `path` пустое)
- значение wildcard берётся из `URL.Path` без дополнительного декодирования

---

## 4. Приоритеты матчинга
На одном уровне сегментов приоритет **строгий**:

1. static
2. param
3. wildcard

Пример:
```text
/users/list      → static
/users/:id       → param
/users/*path     → wildcard
```

`/users/list` всегда матчится как static.

---

## 5. Params

### 5.1 Хранение
Params кладутся в `request.Context()`.

**API:**
- `Param(r, key) string`
- `Params(r) []RouteParam`

### 5.2 Ограничения
- params используются **только** для маршрутизации
- не хранить бизнес‑данные в context

---

## 6. Поведение при ошибках маршрутизации

### 6.1 404 Not Found
- путь не найден ни в одном маршруте

### 6.2 405 Method Not Allowed
- путь найден
- метод не поддерживается
- обязательно вернуть заголовок `Allow`

---

## 7. Mount — базовый примитив зон

### 7.1 Назначение
`Mount(prefix, handler)` используется для:
- `/api`
- `/admin`
- версионирования (`/api/v1`)

---

### 7.2 Правила prefix
- prefix **начинается** с `/`
- prefix **не заканчивается** `/` (кроме `/`)
- `/admin` матчится:
  - `/admin`
  - `/admin/`
  - `/admin/...`
- `/adminX` **не** матчится

---

### 7.3 Поведение Mount
При запросе `/admin/users/42`:
1. prefix `/admin` считается совпавшим
2. prefix отрезается
3. новый `URL.Path` → `/users/42`
4. запрос передаётся в sub‑handler

Если после mount маршрут не найден → `404`.

---

## 8. Trailing slash

v0.1 **не выполняет автоматических редиректов**:
- `/users` и `/users/` — разные пути

Поведение фиксировано и тестируется.

---

## 9. Normalization

v0.1:
- путь используется как есть
- `//` не коллапсируется автоматически

Любая нормализация — явное решение в будущих версиях.

---

## 10. Middleware

- Роутер **не управляет middleware**.
- Middleware применяются снаружи как `http.Handler` обёртки.
- Зональные middleware реализуются через `Mount`.

---

## 11. Минимальный набор тестов
Реализация считается корректной, если покрыты тестами:
- static match
- param match
- приоритеты
- wildcard match
- 404
- 405 + Allow
- mount (root, nested)
- params extraction
- concurrency safety (read)

---

## 12. Гарантии контракта

Этот документ — **нормативный**.

Изменение любого правила:
- увеличивает minor/major версию
- отражается в CHANGELOG

---

**nope routing — boring, strict, predictable.**
